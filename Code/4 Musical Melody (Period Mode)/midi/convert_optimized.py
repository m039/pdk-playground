input_notes = """
#define A3 220
#define Fb4 370
#define E4 330
#define D4 294
#define B3 247
#define G4 392
#define Cb4 277
#define A4 440
#define B4 494
#define Gb4 415
#define Db4 311
#define Cb5 554
"""

input_melody = """
{A3, 121, 125},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {D4, 121, 129},
 {A3, 625, 125},
 {A3, 121, 4},
 {A3, 121, 4},
 {A3, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {D4, 121, 129},
 {B3, 875, 125},
 {B3, 121, 129},
 {G4, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {Cb4, 875, 125},
 {A4, 121, 129},
 {A4, 121, 129},
 {G4, 121, 129},
 {E4, 121, 129},
 {Fb4, 875, 125},
 {A3, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {D4, 121, 129},
 {A3, 750, 0},
 {A3, 250, 0},
 {A3, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {D4, 121, 129},
 {B3, 625, 125},
 {B3, 121, 129},
 {B3, 121, 129},
 {G4, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {A4, 121, 129},
 {A4, 121, 129},
 {A4, 121, 129},
 {A4, 121, 129},
 {B4, 121, 129},
 {A4, 121, 129},
 {G4, 250, 0},
 {E4, 121, 129},
 {D4, 500, 500},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 375, 125},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 375, 125},
 {Fb4, 121, 129},
 {A4, 121, 129},
 {D4, 375, 0},
 {E4, 121, 4},
 {Fb4, 875, 125},
 {G4, 121, 129},
 {G4, 121, 129},
 {G4, 375, 0},
 {G4, 121, 4},
 {G4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 121, 4},
 {Fb4, 121, 4},
 {Fb4, 250, 0},
 {E4, 121, 129},
 {E4, 121, 129},
 {Fb4, 250, 0},
 {E4, 375, 125},
 {A4, 375, 125},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 375, 125},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 375, 125},
 {Fb4, 121, 129},
 {A4, 121, 129},
 {D4, 375, 0},
 {E4, 121, 4},
 {Fb4, 875, 125},
 {G4, 121, 129},
 {G4, 121, 129},
 {G4, 250, 125},
 {G4, 121, 4},
 {G4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 121, 4},
 {Fb4, 121, 4},
 {A4, 121, 129},
 {A4, 121, 129},
 {G4, 121, 129},
 {E4, 121, 129},
 {D4, 625, 375},
 {A3, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {D4, 121, 129},
 {A3, 625, 125},
 {A3, 121, 4},
 {A3, 121, 4},
 {A3, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {D4, 121, 129},
 {B3, 875, 125},
 {B3, 121, 129},
 {G4, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {Cb4, 875, 125},
 {A4, 121, 129},
 {A4, 121, 129},
 {G4, 121, 129},
 {E4, 121, 129},
 {Fb4, 875, 125},
 {A3, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {D4, 121, 129},
 {A3, 750, 0},
 {A3, 250, 0},
 {A3, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {D4, 121, 129},
 {B3, 625, 125},
 {B3, 121, 129},
 {B3, 121, 129},
 {G4, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {A4, 121, 129},
 {A4, 121, 129},
 {A4, 121, 129},
 {A4, 121, 129},
 {B4, 121, 129},
 {A4, 121, 129},
 {G4, 250, 0},
 {E4, 121, 129},
 {D4, 500, 500},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 375, 125},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 375, 125},
 {Fb4, 121, 129},
 {A4, 121, 129},
 {D4, 375, 0},
 {E4, 121, 4},
 {Fb4, 875, 125},
 {G4, 121, 129},
 {G4, 121, 129},
 {G4, 375, 0},
 {G4, 121, 4},
 {G4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 121, 4},
 {Fb4, 121, 4},
 {Fb4, 250, 0},
 {E4, 121, 129},
 {E4, 121, 129},
 {Fb4, 250, 0},
 {E4, 375, 125},
 {A4, 375, 125},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 375, 125},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 375, 125},
 {Fb4, 121, 129},
 {A4, 121, 129},
 {D4, 375, 0},
 {E4, 121, 4},
 {Fb4, 875, 125},
 {G4, 121, 129},
 {G4, 121, 129},
 {G4, 250, 125},
 {G4, 121, 4},
 {G4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Fb4, 121, 4},
 {Fb4, 121, 4},
 {A4, 121, 129},
 {A4, 121, 129},
 {G4, 121, 129},
 {E4, 121, 129},
 {D4, 625, 375},
 {B3, 121, 129},
 {Gb4, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {B3, 625, 125},
 {B3, 121, 4},
 {B3, 121, 4},
 {B3, 121, 129},
 {Gb4, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {Cb4, 875, 125},
 {Cb4, 121, 129},
 {A4, 121, 129},
 {Gb4, 121, 129},
 {Fb4, 121, 129},
 {Db4, 875, 125},
 {B4, 121, 129},
 {B4, 121, 129},
 {A4, 121, 129},
 {Fb4, 121, 129},
 {Gb4, 875, 125},
 {B3, 121, 129},
 {Gb4, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {B3, 750, 0},
 {B3, 250, 0},
 {B3, 121, 129},
 {Gb4, 121, 129},
 {Fb4, 121, 129},
 {E4, 121, 129},
 {Cb4, 625, 125},
 {Cb4, 121, 129},
 {Cb4, 121, 129},
 {A4, 121, 129},
 {Gb4, 121, 129},
 {Fb4, 121, 129},
 {B4, 121, 129},
 {B4, 121, 129},
 {B4, 121, 129},
 {B4, 121, 129},
 {Cb5, 121, 129},
 {B4, 121, 129},
 {A4, 250, 0},
 {Fb4, 121, 129},
 {E4, 500, 500},
 {Gb4, 121, 129},
 {Gb4, 121, 129},
 {Gb4, 375, 125},
 {Gb4, 121, 129},
 {Gb4, 121, 129},
 {Gb4, 375, 125},
 {Gb4, 121, 129},
 {B4, 121, 129},
 {E4, 375, 0},
 {Fb4, 121, 4},
 {Gb4, 875, 125},
 {A4, 121, 129},
 {A4, 121, 129},
 {A4, 375, 0},
 {A4, 121, 4},
 {A4, 121, 129},
 {Gb4, 121, 129},
 {Gb4, 121, 129},
 {Gb4, 121, 4},
 {Gb4, 121, 4},
 {Gb4, 250, 0},
 {Fb4, 121, 129},
 {Fb4, 121, 129},
 {Gb4, 250, 0},
 {Fb4, 375, 125},
 {B4, 375, 125},
 {Gb4, 121, 129},
 {Gb4, 121, 129},
 {Gb4, 375, 125},
 {Gb4, 121, 129},
 {Gb4, 121, 129},
 {Gb4, 375, 125},
 {Gb4, 121, 129},
 {B4, 121, 129},
 {E4, 375, 0},
 {Fb4, 121, 4},
 {Gb4, 875, 125},
 {A4, 121, 129},
 {A4, 121, 129},
 {A4, 250, 125},
 {A4, 121, 4},
 {A4, 121, 129},
 {Gb4, 121, 129},
 {Gb4, 121, 129},
 {Gb4, 121, 4},
 {Gb4, 121, 4},
 {B4, 121, 129},
 {B4, 121, 129},
 {A4, 121, 129},
 {Fb4, 121, 129},
 {E4, 1000, 0},
 """

durations = set({})
notes = {}
melodies = []
not_rounded = {}

def round_duration(x):
    base = 30
    return int(round(x / base) * base)

for n in input_notes.split("\n"):
    n = n.split(" ")
    if len(n) != 3:
        continue

    notes[n[1]] = int(n[2])

for a in input_melody.split("\n"):
    a = a.replace("{", "")
    a = a.replace("}", "")
    a = a.replace(",", "")
    a = a.strip().split(" ")
    if len(a) != 3:
        continue
    
    d = round_duration(int(a[1]))
    nd = round_duration(int(a[2]))

    not_rounded[d] = int(a[1])
    not_rounded[nd] = int(a[2])

    durations.add(d)
    durations.add(nd)

    melodies.append(f"(NOTE_{a[0]} << 10) | (DURATION_{nd} << 5) | DURATION_{d},")

print("""
#include <stdint.h>
#include "delay.h"
""")

notes_list = []

for key, value in notes.items():
    notes_list.append([key, value])

print("#define TONE_FREQ (16000000 / (2 * 64 * 12))")
print("#define F(x) (TONE_FREQ / x - 1)")

print()

for i, n in enumerate(notes_list):
    print(f"#define NOTE_{n[0]} F({n[1]})")

print()

durations = list(durations)

for i, d in enumerate(durations):
    print(f"#define DURATION_{d} {i}")

print()

print("const uint16_t melody_durations[] = {")

for i, d in enumerate(durations):
    print(f"  {not_rounded[d]}, // {i}")

print("};")

print("""  
typedef uint16_t melody_data;
""")

print(f"const melody_data melody[{len(melodies)}] = {{")

for i, m in enumerate(melodies):
    print(f"  {m}")

print("};")

print("""
#define MELODY_SIZE sizeof(melody) / sizeof(melody_data)
#define MELODY_TONE(x) ((melody[x] >> 10) & 0x3f)
#define MELODY_NO_TONE_DURATION(x) melody_durations[(melody[x] >> 5) & 0x1f]
#define MELODY_DURATION(x) melody_durations[melody[x] & 0x1F]

void tone(uint8_t frequency)
{
  if (frequency <= 0) {
    TM2B = 0;
  } else {
    TM2S = 3 << 5 | (12 - 1);
    TM2B = frequency;
  }
}
""")