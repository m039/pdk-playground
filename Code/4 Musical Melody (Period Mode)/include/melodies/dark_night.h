#ifndef _DARK_NIGHT_
#define _DARK_NIGHT_

// https://www.youtube.com/watch?v=Q2CPZw995dY&list=RDACYB1XNs04w&index=14
// https://midifind.com/files/v/voennye_pesni_temnaja_noch/105-1-0-1226

#include <stdint.h>
#include "delay.h"

#define NOTE_A2 1
#define NOTE_A3 2
#define NOTE_C4 3
#define NOTE_C3 4
#define NOTE_B2 5
#define NOTE_B3 6
#define NOTE_E4 7
#define NOTE_D4 8
#define NOTE_A4 9
#define NOTE_C5 10
#define NOTE_B4 11
#define NOTE_F4 12
#define NOTE_G4 13

#define TONE_FREQ (16000000 / (2 * 64 * 3))
#define F(x) (uint8_t)(TONE_FREQ / x - 1)
const uint8_t melody_tones[] = {
  0,
  F(110), // A2
  F(220), // A3
  F(262), // C4
  F(131), // C3
  F(123), // B2
  F(247), // B3
  F(330), // E4
  F(294), // D4
  F(440), // A4
  F(523), // C5
  F(494), // B4
  F(349), // F4
  F(392), // G4
};

#define DURATION_0 0
#define DURATION_167 1
#define DURATION_1000 2
#define DURATION_333 3
#define DURATION_2000 4
#define DURATION_500 5
#define DURATION_1500 6

const uint32_t melody_durations[] = {
  LOOP_CTR_32(MS_TO_CYCLES(0)), // 0
  LOOP_CTR_32(MS_TO_CYCLES(167)), // 1
  LOOP_CTR_32(MS_TO_CYCLES(1000)), // 2
  LOOP_CTR_32(MS_TO_CYCLES(333)), // 3
  LOOP_CTR_32(MS_TO_CYCLES(2000)), // 4
  LOOP_CTR_32(MS_TO_CYCLES(500)), // 5
  LOOP_CTR_32(MS_TO_CYCLES(1500)), // 6
};

typedef struct {
    uint8_t t;
    uint8_t d;
    uint8_t nd;
} melody_data;

const melody_data melody[90] = {
  {NOTE_A2, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_C4, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_C3, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_C4, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_B2, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_B3, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_E4, DURATION_333, DURATION_0},
  {NOTE_D4, DURATION_167, DURATION_0},
  {NOTE_C4, DURATION_333, DURATION_0},
  {NOTE_B3, DURATION_167, DURATION_0},
  {NOTE_A2, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_C4, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_C3, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_C4, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_B2, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_B3, DURATION_333, DURATION_0},
  {NOTE_A3, DURATION_167, DURATION_0},
  {NOTE_E4, DURATION_333, DURATION_0},
  {NOTE_D4, DURATION_167, DURATION_0},
  {NOTE_C4, DURATION_333, DURATION_0},
  {NOTE_B3, DURATION_167, DURATION_0},
  {NOTE_A4, DURATION_500, DURATION_0},
  {NOTE_C5, DURATION_333, DURATION_0},
  {NOTE_B4, DURATION_167, DURATION_0},
  {NOTE_A4, DURATION_1000, DURATION_500},
  {NOTE_F4, DURATION_333, DURATION_0},
  {NOTE_G4, DURATION_167, DURATION_0},
  {NOTE_A4, DURATION_500, DURATION_0},
  {NOTE_G4, DURATION_333, DURATION_0},
  {NOTE_F4, DURATION_167, DURATION_0},
  {NOTE_E4, DURATION_500, DURATION_0},
  {NOTE_E4, DURATION_333, DURATION_0},
  {NOTE_D4, DURATION_167, DURATION_0},
  {NOTE_E4, DURATION_1000, DURATION_500},
  {NOTE_D4, DURATION_333, DURATION_0},
  {NOTE_E4, DURATION_167, DURATION_0},
  {NOTE_F4, DURATION_500, DURATION_0},
  {NOTE_E4, DURATION_333, DURATION_0},
  {NOTE_D4, DURATION_167, DURATION_0},
  {NOTE_A4, DURATION_500, DURATION_0},
  {NOTE_E4, DURATION_333, DURATION_0},
  {NOTE_D4, DURATION_167, DURATION_0},
  {NOTE_C4, DURATION_1000, DURATION_500},
  {NOTE_B3, DURATION_333, DURATION_0},
  {NOTE_C4, DURATION_167, DURATION_0},
  {NOTE_D4, DURATION_500, DURATION_0},
  {NOTE_C4, DURATION_333, DURATION_0},
  {NOTE_B3, DURATION_167, DURATION_0},
  {NOTE_A3, DURATION_500, DURATION_0},
  {NOTE_E4, DURATION_1500, DURATION_2000},
  {NOTE_A4, DURATION_500, DURATION_0},
  {NOTE_C5, DURATION_333, DURATION_0},
  {NOTE_B4, DURATION_167, DURATION_0},
  {NOTE_A4, DURATION_1000, DURATION_500},
  {NOTE_F4, DURATION_333, DURATION_0},
  {NOTE_G4, DURATION_167, DURATION_0},
  {NOTE_A4, DURATION_500, DURATION_0},
  {NOTE_G4, DURATION_333, DURATION_0},
  {NOTE_F4, DURATION_167, DURATION_0},
  {NOTE_E4, DURATION_500, DURATION_0},
  {NOTE_E4, DURATION_333, DURATION_0},
  {NOTE_D4, DURATION_167, DURATION_0},
  {NOTE_E4, DURATION_1000, DURATION_500},
  {NOTE_D4, DURATION_333, DURATION_0},
  {NOTE_E4, DURATION_167, DURATION_0},
  {NOTE_F4, DURATION_500, DURATION_0},
  {NOTE_E4, DURATION_333, DURATION_0},
  {NOTE_D4, DURATION_167, DURATION_0},
  {NOTE_A4, DURATION_500, DURATION_0},
  {NOTE_E4, DURATION_333, DURATION_0},
  {NOTE_D4, DURATION_167, DURATION_0},
  {NOTE_C4, DURATION_1000, DURATION_500},
  {NOTE_B3, DURATION_333, DURATION_0},
  {NOTE_C4, DURATION_167, DURATION_0},
  {NOTE_D4, DURATION_500, DURATION_0},
  {NOTE_E4, DURATION_333, DURATION_0},
  {NOTE_C4, DURATION_167, DURATION_0},
  {NOTE_B3, DURATION_500, DURATION_0},
  {NOTE_A3, DURATION_1500, DURATION_0},
};

#define MELODY_SIZE sizeof(melody) / sizeof(melody_data)
#define MELODY_TONE(x) melody_tones[melody[x].t]
#define MELODY_NO_TONE_DURATION(x) melody_durations[melody[x].nd]
#define MELODY_DURATION(x) melody_durations[melody[x].d]

void tone(uint8_t frequency)
{
  if (frequency <= 0) {
    TM2B = 0;
  } else {
    TM2S = 3 << 5 | 2;
    TM2B = frequency;
  }
}

#endif