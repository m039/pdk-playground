#ifndef _BLUE_VAGON_
#define _BLUE_VAGON_

// https://www.youtube.com/watch?v=_xRN_Ndl-A8&list=RDACYB1XNs04w&index=9
// https://www.midi-karaoke.info/214d2969.ru.html

#include <stdint.h>
#include "delay.h"

#define NOTE_F4 1
#define NOTE_Ab4 2
#define NOTE_Gb4 3
#define NOTE_Fb4 4
#define NOTE_Db4 5
#define NOTE_C5 6
#define NOTE_A4 7
#define NOTE_C4 8
#define NOTE_Cb4 9
#define NOTE_Cb5 10

#define TONE_FREQ (16000000 / (2 * 64 * 3))
#define F(x) (uint8_t)(TONE_FREQ / x - 1)
const uint8_t melody_tones[] = {
  0,
  F(349), // F4
  F(466), // Ab4
  F(415), // Gb4
  F(370), // Fb4
  F(311), // Db4
  F(523), // C5
  F(440), // A4
  F(262), // C4
  F(277), // Cb4
  F(554), // Cb5
};

#define DURATION_0 0
#define DURATION_385 1
#define DURATION_5 2
#define DURATION_646 3
#define DURATION_10 4
#define DURATION_396 5
#define DURATION_526 6
#define DURATION_271 7
#define DURATION_16 8
#define DURATION_276 9
#define DURATION_21 10
#define DURATION_26 11
#define DURATION_922 12
#define DURATION_286 13
#define DURATION_542 14
#define DURATION_672 15
#define DURATION_36 16
#define DURATION_292 17
#define DURATION_42 18
#define DURATION_47 19
#define DURATION_52 20
#define DURATION_438 21
#define DURATION_57 22
#define DURATION_1083 23
#define DURATION_443 24
#define DURATION_188 25
#define DURATION_63 26
#define DURATION_193 27
#define DURATION_458 28
#define DURATION_714 29
#define DURATION_208 30
#define DURATION_464 31
#define DURATION_219 32
#define DURATION_479 33
#define DURATION_1125 34
#define DURATION_229 35
#define DURATION_234 36
#define DURATION_875 37
#define DURATION_760 38
#define DURATION_250 39
#define DURATION_255 40

const uint32_t melody_durations[] = {
  LOOP_CTR_32(MS_TO_CYCLES(0)), // 0
  LOOP_CTR_32(MS_TO_CYCLES(385)), // 1
  LOOP_CTR_32(MS_TO_CYCLES(5)), // 2
  LOOP_CTR_32(MS_TO_CYCLES(646)), // 3
  LOOP_CTR_32(MS_TO_CYCLES(10)), // 4
  LOOP_CTR_32(MS_TO_CYCLES(396)), // 5
  LOOP_CTR_32(MS_TO_CYCLES(526)), // 6
  LOOP_CTR_32(MS_TO_CYCLES(271)), // 7
  LOOP_CTR_32(MS_TO_CYCLES(16)), // 8
  LOOP_CTR_32(MS_TO_CYCLES(276)), // 9
  LOOP_CTR_32(MS_TO_CYCLES(21)), // 10
  LOOP_CTR_32(MS_TO_CYCLES(26)), // 11
  LOOP_CTR_32(MS_TO_CYCLES(922)), // 12
  LOOP_CTR_32(MS_TO_CYCLES(286)), // 13
  LOOP_CTR_32(MS_TO_CYCLES(542)), // 14
  LOOP_CTR_32(MS_TO_CYCLES(672)), // 15
  LOOP_CTR_32(MS_TO_CYCLES(36)), // 16
  LOOP_CTR_32(MS_TO_CYCLES(292)), // 17
  LOOP_CTR_32(MS_TO_CYCLES(42)), // 18
  LOOP_CTR_32(MS_TO_CYCLES(47)), // 19
  LOOP_CTR_32(MS_TO_CYCLES(52)), // 20
  LOOP_CTR_32(MS_TO_CYCLES(438)), // 21
  LOOP_CTR_32(MS_TO_CYCLES(57)), // 22
  LOOP_CTR_32(MS_TO_CYCLES(1083)), // 23
  LOOP_CTR_32(MS_TO_CYCLES(443)), // 24
  LOOP_CTR_32(MS_TO_CYCLES(188)), // 25
  LOOP_CTR_32(MS_TO_CYCLES(63)), // 26
  LOOP_CTR_32(MS_TO_CYCLES(193)), // 27
  LOOP_CTR_32(MS_TO_CYCLES(458)), // 28
  LOOP_CTR_32(MS_TO_CYCLES(714)), // 29
  LOOP_CTR_32(MS_TO_CYCLES(208)), // 30
  LOOP_CTR_32(MS_TO_CYCLES(464)), // 31
  LOOP_CTR_32(MS_TO_CYCLES(219)), // 32
  LOOP_CTR_32(MS_TO_CYCLES(479)), // 33
  LOOP_CTR_32(MS_TO_CYCLES(1125)), // 34
  LOOP_CTR_32(MS_TO_CYCLES(229)), // 35
  LOOP_CTR_32(MS_TO_CYCLES(234)), // 36
  LOOP_CTR_32(MS_TO_CYCLES(875)), // 37
  LOOP_CTR_32(MS_TO_CYCLES(760)), // 38
  LOOP_CTR_32(MS_TO_CYCLES(250)), // 39
  LOOP_CTR_32(MS_TO_CYCLES(255)), // 40
};

typedef struct {
    uint8_t t;
    uint8_t d;
    uint8_t nd;
} melody_data;

const melody_data melody[156] = {
  {NOTE_F4, DURATION_208, DURATION_21},
  {NOTE_Ab4, DURATION_250, DURATION_21},
  {NOTE_Ab4, DURATION_250, DURATION_5},
  {NOTE_Ab4, DURATION_250, DURATION_21},
  {NOTE_Gb4, DURATION_458, DURATION_26},
  {NOTE_Fb4, DURATION_438, DURATION_63},
  {NOTE_Fb4, DURATION_672, DURATION_385},
  {NOTE_Gb4, DURATION_250, DURATION_5},
  {NOTE_Gb4, DURATION_255, DURATION_21},
  {NOTE_Gb4, DURATION_234, DURATION_36},
  {NOTE_Fb4, DURATION_276, DURATION_10},
  {NOTE_F4, DURATION_875, DURATION_1125},
  {NOTE_F4, DURATION_208, DURATION_21},
  {NOTE_Ab4, DURATION_271, DURATION_0},
  {NOTE_Ab4, DURATION_250, DURATION_21},
  {NOTE_Ab4, DURATION_229, DURATION_16},
  {NOTE_Fb4, DURATION_271, DURATION_0},
  {NOTE_Db4, DURATION_464, DURATION_16},
  {NOTE_Ab4, DURATION_276, DURATION_760},
  {NOTE_Ab4, DURATION_234, DURATION_16},
  {NOTE_Ab4, DURATION_250, DURATION_16},
  {NOTE_C5, DURATION_234, DURATION_16},
  {NOTE_A4, DURATION_250, DURATION_0},
  {NOTE_Ab4, DURATION_1083, DURATION_922},
  {NOTE_Ab4, DURATION_443, DURATION_52},
  {NOTE_F4, DURATION_188, DURATION_47},
  {NOTE_Ab4, DURATION_193, DURATION_57},
  {NOTE_Gb4, DURATION_234, DURATION_16},
  {NOTE_Fb4, DURATION_234, DURATION_16},
  {NOTE_Db4, DURATION_479, DURATION_16},
  {NOTE_F4, DURATION_250, DURATION_36},
  {NOTE_C4, DURATION_458, DURATION_5},
  {NOTE_Fb4, DURATION_250, DURATION_16},
  {NOTE_F4, DURATION_250, DURATION_0},
  {NOTE_Cb4, DURATION_229, DURATION_526},
  {NOTE_Ab4, DURATION_229, DURATION_21},
  {NOTE_Fb4, DURATION_438, DURATION_63},
  {NOTE_Cb5, DURATION_229, DURATION_21},
  {NOTE_C5, DURATION_234, DURATION_10},
  {NOTE_Cb5, DURATION_255, DURATION_21},
  {NOTE_Ab4, DURATION_646, DURATION_396},
  {NOTE_Ab4, DURATION_443, DURATION_57},
  {NOTE_F4, DURATION_250, DURATION_21},
  {NOTE_F4, DURATION_234, DURATION_42},
  {NOTE_Cb4, DURATION_255, DURATION_219},
  {NOTE_Ab4, DURATION_464, DURATION_36},
  {NOTE_Ab4, DURATION_250, DURATION_5},
  {NOTE_Fb4, DURATION_458, DURATION_36},
  {NOTE_Cb5, DURATION_208, DURATION_21},
  {NOTE_Cb5, DURATION_234, DURATION_36},
  {NOTE_Ab4, DURATION_714, DURATION_286},
  {NOTE_F4, DURATION_208, DURATION_21},
  {NOTE_Ab4, DURATION_250, DURATION_21},
  {NOTE_Ab4, DURATION_250, DURATION_5},
  {NOTE_Ab4, DURATION_250, DURATION_21},
  {NOTE_Gb4, DURATION_458, DURATION_26},
  {NOTE_Fb4, DURATION_438, DURATION_63},
  {NOTE_Fb4, DURATION_672, DURATION_385},
  {NOTE_Gb4, DURATION_250, DURATION_5},
  {NOTE_Gb4, DURATION_255, DURATION_21},
  {NOTE_Gb4, DURATION_234, DURATION_36},
  {NOTE_Fb4, DURATION_276, DURATION_10},
  {NOTE_F4, DURATION_875, DURATION_1125},
  {NOTE_F4, DURATION_208, DURATION_21},
  {NOTE_Ab4, DURATION_271, DURATION_0},
  {NOTE_Ab4, DURATION_250, DURATION_21},
  {NOTE_Ab4, DURATION_229, DURATION_16},
  {NOTE_Fb4, DURATION_271, DURATION_0},
  {NOTE_Db4, DURATION_464, DURATION_16},
  {NOTE_Ab4, DURATION_276, DURATION_760},
  {NOTE_Ab4, DURATION_234, DURATION_16},
  {NOTE_Ab4, DURATION_250, DURATION_16},
  {NOTE_C5, DURATION_234, DURATION_16},
  {NOTE_A4, DURATION_250, DURATION_0},
  {NOTE_Ab4, DURATION_1083, DURATION_922},
  {NOTE_Ab4, DURATION_443, DURATION_52},
  {NOTE_F4, DURATION_188, DURATION_47},
  {NOTE_Ab4, DURATION_193, DURATION_57},
  {NOTE_Gb4, DURATION_234, DURATION_16},
  {NOTE_Fb4, DURATION_234, DURATION_16},
  {NOTE_Db4, DURATION_479, DURATION_16},
  {NOTE_F4, DURATION_250, DURATION_36},
  {NOTE_C4, DURATION_458, DURATION_5},
  {NOTE_Fb4, DURATION_250, DURATION_16},
  {NOTE_F4, DURATION_250, DURATION_0},
  {NOTE_Cb4, DURATION_229, DURATION_292},
  {NOTE_Ab4, DURATION_438, DURATION_21},
  {NOTE_Ab4, DURATION_229, DURATION_21},
  {NOTE_Fb4, DURATION_438, DURATION_63},
  {NOTE_Cb5, DURATION_229, DURATION_21},
  {NOTE_C5, DURATION_234, DURATION_10},
  {NOTE_Cb5, DURATION_255, DURATION_21},
  {NOTE_Ab4, DURATION_646, DURATION_396},
  {NOTE_Ab4, DURATION_443, DURATION_57},
  {NOTE_F4, DURATION_250, DURATION_21},
  {NOTE_F4, DURATION_234, DURATION_42},
  {NOTE_Cb4, DURATION_255, DURATION_219},
  {NOTE_Ab4, DURATION_464, DURATION_36},
  {NOTE_Ab4, DURATION_250, DURATION_5},
  {NOTE_Fb4, DURATION_458, DURATION_36},
  {NOTE_Cb5, DURATION_208, DURATION_21},
  {NOTE_Cb5, DURATION_234, DURATION_36},
  {NOTE_Ab4, DURATION_714, DURATION_286},
  {NOTE_F4, DURATION_208, DURATION_21},
  {NOTE_Ab4, DURATION_250, DURATION_21},
  {NOTE_Ab4, DURATION_250, DURATION_5},
  {NOTE_Ab4, DURATION_250, DURATION_21},
  {NOTE_Gb4, DURATION_458, DURATION_26},
  {NOTE_Fb4, DURATION_438, DURATION_63},
  {NOTE_Fb4, DURATION_672, DURATION_385},
  {NOTE_Gb4, DURATION_250, DURATION_5},
  {NOTE_Gb4, DURATION_255, DURATION_21},
  {NOTE_Gb4, DURATION_234, DURATION_36},
  {NOTE_Fb4, DURATION_276, DURATION_10},
  {NOTE_F4, DURATION_875, DURATION_1125},
  {NOTE_F4, DURATION_208, DURATION_21},
  {NOTE_Ab4, DURATION_271, DURATION_0},
  {NOTE_Ab4, DURATION_250, DURATION_21},
  {NOTE_Ab4, DURATION_229, DURATION_16},
  {NOTE_Fb4, DURATION_271, DURATION_0},
  {NOTE_Db4, DURATION_464, DURATION_16},
  {NOTE_Ab4, DURATION_276, DURATION_760},
  {NOTE_Ab4, DURATION_234, DURATION_16},
  {NOTE_Ab4, DURATION_250, DURATION_16},
  {NOTE_C5, DURATION_234, DURATION_16},
  {NOTE_A4, DURATION_250, DURATION_0},
  {NOTE_Ab4, DURATION_1083, DURATION_922},
  {NOTE_Ab4, DURATION_443, DURATION_52},
  {NOTE_F4, DURATION_188, DURATION_47},
  {NOTE_Ab4, DURATION_193, DURATION_57},
  {NOTE_Gb4, DURATION_234, DURATION_16},
  {NOTE_Fb4, DURATION_234, DURATION_16},
  {NOTE_Db4, DURATION_479, DURATION_16},
  {NOTE_F4, DURATION_250, DURATION_36},
  {NOTE_C4, DURATION_458, DURATION_5},
  {NOTE_Fb4, DURATION_250, DURATION_16},
  {NOTE_F4, DURATION_250, DURATION_0},
  {NOTE_Cb4, DURATION_229, DURATION_542},
  {NOTE_Ab4, DURATION_208, DURATION_26},
  {NOTE_A4, DURATION_208, DURATION_36},
  {NOTE_Ab4, DURATION_229, DURATION_21},
  {NOTE_Fb4, DURATION_438, DURATION_63},
  {NOTE_Cb5, DURATION_229, DURATION_21},
  {NOTE_C5, DURATION_234, DURATION_10},
  {NOTE_Cb5, DURATION_255, DURATION_21},
  {NOTE_Ab4, DURATION_646, DURATION_396},
  {NOTE_Ab4, DURATION_443, DURATION_57},
  {NOTE_F4, DURATION_250, DURATION_21},
  {NOTE_F4, DURATION_234, DURATION_42},
  {NOTE_Cb4, DURATION_255, DURATION_219},
  {NOTE_Ab4, DURATION_464, DURATION_36},
  {NOTE_Ab4, DURATION_250, DURATION_5},
  {NOTE_Fb4, DURATION_458, DURATION_36},
  {NOTE_Cb5, DURATION_208, DURATION_21},
  {NOTE_Cb5, DURATION_234, DURATION_36},
  {NOTE_Ab4, DURATION_714, DURATION_0},
};

#define MELODY_SIZE sizeof(melody) / sizeof(melody_data)
#define MELODY_TONE(x) melody_tones[melody[x].t]
#define MELODY_NO_TONE_DURATION(x) melody_durations[melody[x].nd]
#define MELODY_DURATION(x) melody_durations[melody[x].d]

void tone(uint8_t frequency)
{
  if (frequency <= 0) {
    TM2B = 0;
  } else {
    TM2S = 3 << 5 | 2;
    TM2B = frequency;
  }
}

#endif