#ifndef _AIR_MARCH_
#define _AIR_MARCH_

// https://www.youtube.com/watch?v=rbmhmaWu4lM&list=RDrbmhmaWu4lM&start_radio=1
// https://musescore.com/crono23/air-march-1923

#include <stdint.h>
#include "delay.h"

#define NOTE_G4 1
#define NOTE_Fb4 2
#define NOTE_A4 3
#define NOTE_B4 4
#define NOTE_Ab4 5
#define NOTE_C5 6
#define NOTE_D5 7
#define NOTE_Cb5 8
#define NOTE_E5 9
#define NOTE_F5 10
#define NOTE_G3 11
#define NOTE_A3 12
#define NOTE_C4 13
#define NOTE_Db5 14
#define NOTE_D4 15
#define NOTE_E4 16
#define NOTE_Gb4 17
#define NOTE_G5 18
#define NOTE_C6 19

#define TONE_FREQ (16000000 / (2 * 64 * 3))
#define F(x) (uint8_t)(TONE_FREQ / x - 1)
const uint8_t melody_tones[] = {
  0,
  F(392), // G4
  F(370), // Fb4
  F(440), // A4
  F(494), // B4
  F(466), // Ab4
  F(523), // C5
  F(587), // D5
  F(554), // Cb5
  F(659), // E5
  F(698), // F5
  F(196), // G3
  F(220), // A3
  F(262), // C4
  F(622), // Db5
  F(294), // D4
  F(330), // E4
  F(415), // Gb4
  F(784), // G5
  F(1047), // C6
};

#define DURATION_0 0
#define DURATION_1 1
#define DURATION_5 2
#define DURATION_7 3
#define DURATION_264 4
#define DURATION_14 5
#define DURATION_276 6
#define DURATION_26 7
#define DURATION_289 8
#define DURATION_39 9
#define DURATION_711 10
#define DURATION_78 11
#define DURATION_474 12
#define DURATION_236 13
#define DURATION_499 14
#define DURATION_118 15
#define DURATION_249 16
#define DURATION_251 17
#define DURATION_124 18

const uint16_t melody_durations[] = {
  0, // 0
  1, // 1
  5, // 2
  7, // 3
  264, // 4
  14, // 5
  276, // 6
  26, // 7
  289, // 8
  39, // 9
  711, // 10
  78, // 11
  474, // 12
  236, // 13
  499, // 14
  118, // 15
  249, // 16
  251, // 17
  124, // 18
};

typedef struct {
    uint8_t t;
    uint8_t d;
    uint8_t nd;
} melody_data;

const melody_data melody[125] = {
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_G4, DURATION_124, DURATION_1},
  {NOTE_Fb4, DURATION_124, DURATION_1},
  {NOTE_G4, DURATION_124, DURATION_1},
  {NOTE_A4, DURATION_118, DURATION_7},
  {NOTE_B4, DURATION_236, DURATION_14},
  {NOTE_B4, DURATION_236, DURATION_14},
  {NOTE_B4, DURATION_474, DURATION_26},
  {NOTE_B4, DURATION_236, DURATION_14},
  {NOTE_B4, DURATION_236, DURATION_14},
  {NOTE_B4, DURATION_124, DURATION_1},
  {NOTE_Ab4, DURATION_124, DURATION_1},
  {NOTE_B4, DURATION_124, DURATION_1},
  {NOTE_C5, DURATION_118, DURATION_7},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_474, DURATION_26},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_124, DURATION_1},
  {NOTE_Cb5, DURATION_124, DURATION_1},
  {NOTE_D5, DURATION_124, DURATION_1},
  {NOTE_E5, DURATION_118, DURATION_7},
  {NOTE_F5, DURATION_236, DURATION_14},
  {NOTE_F5, DURATION_236, DURATION_14},
  {NOTE_F5, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_78, DURATION_5},
  {NOTE_F5, DURATION_78, DURATION_5},
  {NOTE_E5, DURATION_78, DURATION_5},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_78, DURATION_5},
  {NOTE_D5, DURATION_78, DURATION_5},
  {NOTE_C5, DURATION_78, DURATION_5},
  {NOTE_B4, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_78, DURATION_5},
  {NOTE_B4, DURATION_78, DURATION_5},
  {NOTE_A4, DURATION_78, DURATION_5},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_G3, DURATION_249, DURATION_1},
  {NOTE_A3, DURATION_249, DURATION_1},
  {NOTE_C4, DURATION_249, DURATION_1},
  {NOTE_C4, DURATION_236, DURATION_264},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_236, DURATION_264},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_B4, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_236, DURATION_264},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_B4, DURATION_236, DURATION_264},
  {NOTE_B4, DURATION_236, DURATION_264},
  {NOTE_Cb5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_236, DURATION_14},
  {NOTE_F5, DURATION_711, DURATION_39},
  {NOTE_E5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_Cb5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_Db5, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_474, DURATION_26},
  {NOTE_C5, DURATION_474, DURATION_276},
  {NOTE_B4, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_474, DURATION_26},
  {NOTE_D5, DURATION_474, DURATION_26},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_B4, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_G4, DURATION_474, DURATION_26},
  {NOTE_G4, DURATION_711, DURATION_289},
  {NOTE_G4, DURATION_474, DURATION_26},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_249, DURATION_251},
  {NOTE_B4, DURATION_474, DURATION_26},
  {NOTE_A4, DURATION_236, DURATION_264},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_236, DURATION_14},
  {NOTE_D4, DURATION_236, DURATION_14},
  {NOTE_E4, DURATION_711, DURATION_39},
  {NOTE_E5, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_474, DURATION_26},
  {NOTE_Db5, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_236, DURATION_14},
  {NOTE_F5, DURATION_474, DURATION_26},
  {NOTE_E5, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_Gb4, DURATION_236, DURATION_14},
  {NOTE_Ab4, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_711, DURATION_39},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_F5, DURATION_499, DURATION_1},
  {NOTE_E5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_Cb5, DURATION_474, DURATION_26},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_474, DURATION_26},
  {NOTE_C5, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_G4, DURATION_711, DURATION_39},
  {NOTE_G4, DURATION_236, DURATION_14},
  {NOTE_E4, DURATION_236, DURATION_14},
  {NOTE_A4, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_236, DURATION_14},
  {NOTE_E5, DURATION_474, DURATION_26},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_D5, DURATION_236, DURATION_14},
  {NOTE_C5, DURATION_236, DURATION_264},
  {NOTE_G5, DURATION_236, DURATION_264},
  {NOTE_C6, DURATION_236, DURATION_0},
};

#define MELODY_SIZE sizeof(melody) / sizeof(melody_data)
#define MELODY_TONE(x) melody_tones[melody[x].t]
#define MELODY_NO_TONE_DURATION(x) melody_durations[melody[x].nd]
#define MELODY_DURATION(x) melody_durations[melody[x].d]

void tone(uint8_t frequency)
{
  if (frequency <= 0) {
    TM2B = 0;
  } else {
    TM2S = 3 << 5 | 2;
    TM2B = frequency;
  }
}

#endif