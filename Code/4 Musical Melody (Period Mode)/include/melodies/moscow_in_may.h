#ifndef _MOSCOW_IN_MAY
#define _MOSCOW_IN_MAY

// https://www.youtube.com/watch?v=t892M-wR3uQ&list=RDt892M-wR3uQ&start_radio=1
// https://musescore.com/the_alex/scores/7054048

#include <stdint.h>
#include "delay.h"

#define NOTE_B4 1
#define NOTE_A4 2
#define NOTE_G4 3
#define NOTE_E4 4
#define NOTE_Db4 5
#define NOTE_Fb4 6
#define NOTE_B3 7
#define NOTE_E5 8
#define NOTE_D5 9
#define NOTE_C5 10
#define NOTE_D4 11

#define TONE_FREQ (16000000 / (2 * 64 * 3))
#define F(x) (uint8_t)(TONE_FREQ / x - 1)
const uint8_t melody_tones[] = {
  0,
  F(494), // B4
  F(440), // A4
  F(392), // G4
  F(330), // E4
  F(311), // Db4
  F(370), // Fb4
  F(247), // B3
  F(659), // E5
  F(587), // D5
  F(523), // C5
  F(294), // D4
};

#define DURATION_480 0
#define DURATION_1 1
#define DURATION_1249 2
#define DURATION_0 3
#define DURATION_356 4
#define DURATION_999 5
#define DURATION_749 6
#define DURATION_14 7
#define DURATION_499 8
#define DURATION_20 9
#define DURATION_501 10
#define DURATION_374 11
#define DURATION_19 12
#define DURATION_249 13
#define DURATION_986 14
#define DURATION_1499 15
#define DURATION_124 16

const uint32_t melody_durations[] = {
  LOOP_CTR_32(MS_TO_CYCLES(480)), // 0
  LOOP_CTR_32(MS_TO_CYCLES(1)), // 1
  LOOP_CTR_32(MS_TO_CYCLES(1249)), // 2
  LOOP_CTR_32(MS_TO_CYCLES(0)), // 3
  LOOP_CTR_32(MS_TO_CYCLES(356)), // 4
  LOOP_CTR_32(MS_TO_CYCLES(999)), // 5
  LOOP_CTR_32(MS_TO_CYCLES(749)), // 6
  LOOP_CTR_32(MS_TO_CYCLES(14)), // 7
  LOOP_CTR_32(MS_TO_CYCLES(499)), // 8
  LOOP_CTR_32(MS_TO_CYCLES(20)), // 9
  LOOP_CTR_32(MS_TO_CYCLES(501)), // 10
  LOOP_CTR_32(MS_TO_CYCLES(374)), // 11
  LOOP_CTR_32(MS_TO_CYCLES(19)), // 12
  LOOP_CTR_32(MS_TO_CYCLES(249)), // 13
  LOOP_CTR_32(MS_TO_CYCLES(986)), // 14
  LOOP_CTR_32(MS_TO_CYCLES(1499)), // 15
  LOOP_CTR_32(MS_TO_CYCLES(124)), // 16
};

typedef struct {
    uint8_t t;
    uint8_t d;
    uint8_t nd;
} melody_data;

const melody_data melody[153] = {
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_E4, DURATION_999, DURATION_1},
  {NOTE_Db4, DURATION_249, DURATION_1},
  {NOTE_E4, DURATION_249, DURATION_1},
  {NOTE_Fb4, DURATION_499, DURATION_1},
  {NOTE_B3, DURATION_999, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_E4, DURATION_499, DURATION_1},
  {NOTE_E5, DURATION_749, DURATION_1},
  {NOTE_D5, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_1499, DURATION_1},
  {NOTE_D5, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_249, DURATION_1},
  {NOTE_B4, DURATION_749, DURATION_1},
  {NOTE_G4, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_499, DURATION_1},
  {NOTE_A4, DURATION_499, DURATION_1},
  {NOTE_Fb4, DURATION_999, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_749, DURATION_1},
  {NOTE_E4, DURATION_249, DURATION_1},
  {NOTE_Db4, DURATION_499, DURATION_1},
  {NOTE_E4, DURATION_499, DURATION_1},
  {NOTE_Fb4, DURATION_999, DURATION_501},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_E4, DURATION_999, DURATION_1},
  {NOTE_Db4, DURATION_249, DURATION_1},
  {NOTE_E4, DURATION_249, DURATION_1},
  {NOTE_Fb4, DURATION_499, DURATION_1},
  {NOTE_B3, DURATION_999, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_E4, DURATION_499, DURATION_1},
  {NOTE_E5, DURATION_749, DURATION_1},
  {NOTE_D5, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_1499, DURATION_1},
  {NOTE_D5, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_249, DURATION_1},
  {NOTE_B4, DURATION_499, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_C5, DURATION_499, DURATION_1},
  {NOTE_B4, DURATION_499, DURATION_1},
  {NOTE_A4, DURATION_499, DURATION_1},
  {NOTE_Fb4, DURATION_999, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_749, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_Fb4, DURATION_499, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_E4, DURATION_999, DURATION_501},
  {NOTE_D4, DURATION_499, DURATION_1},
  {NOTE_B4, DURATION_374, DURATION_1},
  {NOTE_A4, DURATION_124, DURATION_1},
  {NOTE_G4, DURATION_999, DURATION_1},
  {NOTE_D4, DURATION_499, DURATION_1},
  {NOTE_C5, DURATION_374, DURATION_1},
  {NOTE_B4, DURATION_124, DURATION_1},
  {NOTE_A4, DURATION_999, DURATION_1},
  {NOTE_D4, DURATION_499, DURATION_1},
  {NOTE_Fb4, DURATION_749, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_499, DURATION_1},
  {NOTE_E5, DURATION_499, DURATION_1},
  {NOTE_D5, DURATION_374, DURATION_1},
  {NOTE_C5, DURATION_124, DURATION_1},
  {NOTE_B4, DURATION_999, DURATION_1},
  {NOTE_D4, DURATION_499, DURATION_1},
  {NOTE_B4, DURATION_374, DURATION_1},
  {NOTE_A4, DURATION_124, DURATION_1},
  {NOTE_G4, DURATION_999, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_C5, DURATION_374, DURATION_1},
  {NOTE_D5, DURATION_124, DURATION_1},
  {NOTE_E5, DURATION_999, DURATION_1},
  {NOTE_E5, DURATION_499, DURATION_1},
  {NOTE_D5, DURATION_374, DURATION_1},
  {NOTE_C5, DURATION_124, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_D5, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_499, DURATION_1},
  {NOTE_A4, DURATION_499, DURATION_1},
  {NOTE_G4, DURATION_999, DURATION_501},
  {NOTE_D4, DURATION_499, DURATION_1},
  {NOTE_B4, DURATION_374, DURATION_1},
  {NOTE_A4, DURATION_124, DURATION_1},
  {NOTE_G4, DURATION_999, DURATION_1},
  {NOTE_D4, DURATION_499, DURATION_1},
  {NOTE_C5, DURATION_374, DURATION_1},
  {NOTE_B4, DURATION_124, DURATION_1},
  {NOTE_A4, DURATION_1249, DURATION_1},
  {NOTE_D4, DURATION_249, DURATION_1},
  {NOTE_Fb4, DURATION_749, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_499, DURATION_1},
  {NOTE_E5, DURATION_499, DURATION_1},
  {NOTE_D5, DURATION_374, DURATION_1},
  {NOTE_C5, DURATION_124, DURATION_1},
  {NOTE_B4, DURATION_999, DURATION_1},
  {NOTE_D4, DURATION_499, DURATION_1},
  {NOTE_B4, DURATION_374, DURATION_1},
  {NOTE_A4, DURATION_124, DURATION_1},
  {NOTE_G4, DURATION_999, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_C5, DURATION_374, DURATION_1},
  {NOTE_D5, DURATION_124, DURATION_1},
  {NOTE_E5, DURATION_986, DURATION_14},
  {NOTE_E5, DURATION_480, DURATION_20},
  {NOTE_D5, DURATION_356, DURATION_19},
  {NOTE_C5, DURATION_124, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_D5, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_499, DURATION_1},
  {NOTE_A4, DURATION_499, DURATION_1},
  {NOTE_G4, DURATION_1499, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_E4, DURATION_999, DURATION_1},
  {NOTE_Db4, DURATION_249, DURATION_1},
  {NOTE_E4, DURATION_249, DURATION_1},
  {NOTE_Fb4, DURATION_499, DURATION_1},
  {NOTE_B3, DURATION_999, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_499, DURATION_1},
  {NOTE_E4, DURATION_499, DURATION_1},
  {NOTE_E5, DURATION_749, DURATION_1},
  {NOTE_D5, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_1499, DURATION_1},
  {NOTE_D5, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_249, DURATION_1},
  {NOTE_B4, DURATION_749, DURATION_1},
  {NOTE_G4, DURATION_249, DURATION_1},
  {NOTE_C5, DURATION_499, DURATION_1},
  {NOTE_B4, DURATION_499, DURATION_1},
  {NOTE_A4, DURATION_499, DURATION_1},
  {NOTE_Fb4, DURATION_999, DURATION_1},
  {NOTE_B4, DURATION_249, DURATION_1},
  {NOTE_A4, DURATION_249, DURATION_1},
  {NOTE_G4, DURATION_749, DURATION_1},
  {NOTE_E4, DURATION_249, DURATION_1},
  {NOTE_Db4, DURATION_499, DURATION_1},
  {NOTE_E4, DURATION_499, DURATION_1},
  {NOTE_Fb4, DURATION_999, DURATION_0},
};

#define MELODY_SIZE sizeof(melody) / sizeof(melody_data)
#define MELODY_TONE(x) melody_tones[melody[x].t]
#define MELODY_NO_TONE_DURATION(x) melody_durations[melody[x].nd]
#define MELODY_DURATION(x) melody_durations[melody[x].d]

void tone(uint8_t frequency)
{
  if (frequency <= 0) {
    TM2B = 0;
  } else {
    TM2S = 3 << 5 | 2;
    TM2B = frequency;
  }
}

#endif