#ifndef _KOMAROVO_
#define _KOMAROVO_

// https://www.youtube.com/watch?v=G6NqhIYzpZM&list=RDACYB1XNs04w&index=4
// https://www.midi-karaoke.info/215c2f1d.ru.html

#include <stdint.h>
#include "delay.h"

#define NOTE_A4 1
#define NOTE_Ab4 2
#define NOTE_C5 3
#define NOTE_G4 4
#define NOTE_F4 5
#define NOTE_D5 6
#define NOTE_E4 7
#define NOTE_D4 8
#define NOTE_E5 9
#define NOTE_F5 10
#define NOTE_G5 11
#define NOTE_Cb5 12

#define TONE_FREQ (16000000 / (2 * 64 * 3))
#define F(x) (uint8_t)(TONE_FREQ / x - 1)
const uint8_t melody_tones[] = {
  0,
  F(440), // A4
  F(466), // Ab4
  F(523), // C5
  F(392), // G4
  F(349), // F4
  F(587), // D5
  F(330), // E4
  F(294), // D4
  F(659), // E5
  F(698), // F5
  F(784), // G5
  F(554), // Cb5
};

#define DURATION_0 0
#define DURATION_129 1
#define DURATION_133 2
#define DURATION_137 3
#define DURATION_138 4
#define DURATION_271 5
#define DURATION_17 6
#define DURATION_146 7
#define DURATION_275 8
#define DURATION_21 9
#define DURATION_150 10
#define DURATION_25 11
#define DURATION_283 12
#define DURATION_29 13
#define DURATION_158 14
#define DURATION_33 15
#define DURATION_163 16
#define DURATION_37 17
#define DURATION_38 18
#define DURATION_421 19
#define DURATION_42 20
#define DURATION_171 21
#define DURATION_300 22
#define DURATION_46 23
#define DURATION_175 24
#define DURATION_50 25
#define DURATION_179 26
#define DURATION_54 27
#define DURATION_183 28
#define DURATION_1079 29
#define DURATION_313 30
#define DURATION_58 31
#define DURATION_188 32
#define DURATION_63 33
#define DURATION_192 34
#define DURATION_67 35
#define DURATION_196 36
#define DURATION_325 37
#define DURATION_1092 38
#define DURATION_71 39
#define DURATION_200 40
#define DURATION_458 41
#define DURATION_75 42
#define DURATION_333 43
#define DURATION_846 44
#define DURATION_79 45
#define DURATION_208 46
#define DURATION_337 47
#define DURATION_83 48
#define DURATION_212 49
#define DURATION_213 50
#define DURATION_1108 51
#define DURATION_87 52
#define DURATION_1113 53
#define DURATION_346 54
#define DURATION_217 55
#define DURATION_92 56
#define DURATION_221 57
#define DURATION_350 58
#define DURATION_1117 59
#define DURATION_96 60
#define DURATION_225 61
#define DURATION_354 62
#define DURATION_483 63
#define DURATION_100 64
#define DURATION_104 65
#define DURATION_363 66
#define DURATION_108 67
#define DURATION_367 68
#define DURATION_371 69
#define DURATION_117 70
#define DURATION_121 71
#define DURATION_250 72
#define DURATION_125 73

const uint32_t melody_durations[] = {
  LOOP_CTR_32(MS_TO_CYCLES(0)), // 0
  LOOP_CTR_32(MS_TO_CYCLES(129)), // 1
  LOOP_CTR_32(MS_TO_CYCLES(133)), // 2
  LOOP_CTR_32(MS_TO_CYCLES(137)), // 3
  LOOP_CTR_32(MS_TO_CYCLES(138)), // 4
  LOOP_CTR_32(MS_TO_CYCLES(271)), // 5
  LOOP_CTR_32(MS_TO_CYCLES(17)), // 6
  LOOP_CTR_32(MS_TO_CYCLES(146)), // 7
  LOOP_CTR_32(MS_TO_CYCLES(275)), // 8
  LOOP_CTR_32(MS_TO_CYCLES(21)), // 9
  LOOP_CTR_32(MS_TO_CYCLES(150)), // 10
  LOOP_CTR_32(MS_TO_CYCLES(25)), // 11
  LOOP_CTR_32(MS_TO_CYCLES(283)), // 12
  LOOP_CTR_32(MS_TO_CYCLES(29)), // 13
  LOOP_CTR_32(MS_TO_CYCLES(158)), // 14
  LOOP_CTR_32(MS_TO_CYCLES(33)), // 15
  LOOP_CTR_32(MS_TO_CYCLES(163)), // 16
  LOOP_CTR_32(MS_TO_CYCLES(37)), // 17
  LOOP_CTR_32(MS_TO_CYCLES(38)), // 18
  LOOP_CTR_32(MS_TO_CYCLES(421)), // 19
  LOOP_CTR_32(MS_TO_CYCLES(42)), // 20
  LOOP_CTR_32(MS_TO_CYCLES(171)), // 21
  LOOP_CTR_32(MS_TO_CYCLES(300)), // 22
  LOOP_CTR_32(MS_TO_CYCLES(46)), // 23
  LOOP_CTR_32(MS_TO_CYCLES(175)), // 24
  LOOP_CTR_32(MS_TO_CYCLES(50)), // 25
  LOOP_CTR_32(MS_TO_CYCLES(179)), // 26
  LOOP_CTR_32(MS_TO_CYCLES(54)), // 27
  LOOP_CTR_32(MS_TO_CYCLES(183)), // 28
  LOOP_CTR_32(MS_TO_CYCLES(1079)), // 29
  LOOP_CTR_32(MS_TO_CYCLES(313)), // 30
  LOOP_CTR_32(MS_TO_CYCLES(58)), // 31
  LOOP_CTR_32(MS_TO_CYCLES(188)), // 32
  LOOP_CTR_32(MS_TO_CYCLES(63)), // 33
  LOOP_CTR_32(MS_TO_CYCLES(192)), // 34
  LOOP_CTR_32(MS_TO_CYCLES(67)), // 35
  LOOP_CTR_32(MS_TO_CYCLES(196)), // 36
  LOOP_CTR_32(MS_TO_CYCLES(325)), // 37
  LOOP_CTR_32(MS_TO_CYCLES(1092)), // 38
  LOOP_CTR_32(MS_TO_CYCLES(71)), // 39
  LOOP_CTR_32(MS_TO_CYCLES(200)), // 40
  LOOP_CTR_32(MS_TO_CYCLES(458)), // 41
  LOOP_CTR_32(MS_TO_CYCLES(75)), // 42
  LOOP_CTR_32(MS_TO_CYCLES(333)), // 43
  LOOP_CTR_32(MS_TO_CYCLES(846)), // 44
  LOOP_CTR_32(MS_TO_CYCLES(79)), // 45
  LOOP_CTR_32(MS_TO_CYCLES(208)), // 46
  LOOP_CTR_32(MS_TO_CYCLES(337)), // 47
  LOOP_CTR_32(MS_TO_CYCLES(83)), // 48
  LOOP_CTR_32(MS_TO_CYCLES(212)), // 49
  LOOP_CTR_32(MS_TO_CYCLES(213)), // 50
  LOOP_CTR_32(MS_TO_CYCLES(1108)), // 51
  LOOP_CTR_32(MS_TO_CYCLES(87)), // 52
  LOOP_CTR_32(MS_TO_CYCLES(1113)), // 53
  LOOP_CTR_32(MS_TO_CYCLES(346)), // 54
  LOOP_CTR_32(MS_TO_CYCLES(217)), // 55
  LOOP_CTR_32(MS_TO_CYCLES(92)), // 56
  LOOP_CTR_32(MS_TO_CYCLES(221)), // 57
  LOOP_CTR_32(MS_TO_CYCLES(350)), // 58
  LOOP_CTR_32(MS_TO_CYCLES(1117)), // 59
  LOOP_CTR_32(MS_TO_CYCLES(96)), // 60
  LOOP_CTR_32(MS_TO_CYCLES(225)), // 61
  LOOP_CTR_32(MS_TO_CYCLES(354)), // 62
  LOOP_CTR_32(MS_TO_CYCLES(483)), // 63
  LOOP_CTR_32(MS_TO_CYCLES(100)), // 64
  LOOP_CTR_32(MS_TO_CYCLES(104)), // 65
  LOOP_CTR_32(MS_TO_CYCLES(363)), // 66
  LOOP_CTR_32(MS_TO_CYCLES(108)), // 67
  LOOP_CTR_32(MS_TO_CYCLES(367)), // 68
  LOOP_CTR_32(MS_TO_CYCLES(371)), // 69
  LOOP_CTR_32(MS_TO_CYCLES(117)), // 70
  LOOP_CTR_32(MS_TO_CYCLES(121)), // 71
  LOOP_CTR_32(MS_TO_CYCLES(250)), // 72
  LOOP_CTR_32(MS_TO_CYCLES(125)), // 73
};

typedef struct {
    uint8_t t;
    uint8_t d;
    uint8_t nd;
} melody_data;

const melody_data melody[92] = {
  {NOTE_A4, DURATION_58, DURATION_58},
  {NOTE_A4, DURATION_63, DURATION_71},
  {NOTE_A4, DURATION_200, DURATION_50},
  {NOTE_A4, DURATION_75, DURATION_158},
  {NOTE_Ab4, DURATION_188, DURATION_67},
  {NOTE_A4, DURATION_83, DURATION_54},
  {NOTE_C5, DURATION_325, DURATION_38},
  {NOTE_Ab4, DURATION_133, DURATION_371},
  {NOTE_Ab4, DURATION_67, DURATION_67},
  {NOTE_A4, DURATION_83, DURATION_50},
  {NOTE_G4, DURATION_200, DURATION_50},
  {NOTE_G4, DURATION_83, DURATION_158},
  {NOTE_F4, DURATION_192, DURATION_58},
  {NOTE_G4, DURATION_83, DURATION_54},
  {NOTE_Ab4, DURATION_313, DURATION_50},
  {NOTE_A4, DURATION_146, DURATION_333},
  {NOTE_A4, DURATION_63, DURATION_63},
  {NOTE_A4, DURATION_67, DURATION_63},
  {NOTE_A4, DURATION_300, DURATION_104},
  {NOTE_A4, DURATION_63, DURATION_83},
  {NOTE_Ab4, DURATION_171, DURATION_75},
  {NOTE_A4, DURATION_129, DURATION_108},
  {NOTE_C5, DURATION_225, DURATION_37},
  {NOTE_Ab4, DURATION_117, DURATION_367},
  {NOTE_A4, DURATION_54, DURATION_71},
  {NOTE_Ab4, DURATION_63, DURATION_71},
  {NOTE_A4, DURATION_283, DURATION_83},
  {NOTE_G4, DURATION_58, DURATION_75},
  {NOTE_G4, DURATION_171, DURATION_46},
  {NOTE_D5, DURATION_421, DURATION_350},
  {NOTE_A4, DURATION_79, DURATION_46},
  {NOTE_A4, DURATION_83, DURATION_46},
  {NOTE_A4, DURATION_208, DURATION_46},
  {NOTE_A4, DURATION_146, DURATION_79},
  {NOTE_Ab4, DURATION_192, DURATION_63},
  {NOTE_A4, DURATION_87, DURATION_33},
  {NOTE_C5, DURATION_363, DURATION_25},
  {NOTE_Ab4, DURATION_129, DURATION_346},
  {NOTE_Ab4, DURATION_75, DURATION_58},
  {NOTE_A4, DURATION_79, DURATION_54},
  {NOTE_G4, DURATION_271, DURATION_96},
  {NOTE_G4, DURATION_71, DURATION_67},
  {NOTE_F4, DURATION_221, DURATION_42},
  {NOTE_G4, DURATION_75, DURATION_46},
  {NOTE_Ab4, DURATION_313, DURATION_42},
  {NOTE_A4, DURATION_171, DURATION_333},
  {NOTE_F4, DURATION_54, DURATION_71},
  {NOTE_F4, DURATION_54, DURATION_79},
  {NOTE_F4, DURATION_213, DURATION_29},
  {NOTE_F4, DURATION_129, DURATION_125},
  {NOTE_E4, DURATION_212, DURATION_29},
  {NOTE_F4, DURATION_67, DURATION_63},
  {NOTE_A4, DURATION_371, DURATION_29},
  {NOTE_G4, DURATION_196, DURATION_275},
  {NOTE_G4, DURATION_54, DURATION_83},
  {NOTE_G4, DURATION_46, DURATION_92},
  {NOTE_G4, DURATION_75, DURATION_171},
  {NOTE_F4, DURATION_208, DURATION_42},
  {NOTE_E4, DURATION_96, DURATION_37},
  {NOTE_D4, DURATION_158, DURATION_458},
  {NOTE_D5, DURATION_212, DURATION_50},
  {NOTE_E5, DURATION_87, DURATION_38},
  {NOTE_D5, DURATION_337, DURATION_38},
  {NOTE_C5, DURATION_117, DURATION_1108},
  {NOTE_E5, DURATION_79, DURATION_183},
  {NOTE_E5, DURATION_67, DURATION_54},
  {NOTE_E5, DURATION_354, DURATION_38},
  {NOTE_F5, DURATION_121, DURATION_1117},
  {NOTE_F5, DURATION_137, DURATION_125},
  {NOTE_G5, DURATION_87, DURATION_38},
  {NOTE_F5, DURATION_346, DURATION_17},
  {NOTE_E5, DURATION_158, DURATION_1092},
  {NOTE_E5, DURATION_137, DURATION_100},
  {NOTE_F5, DURATION_87, DURATION_42},
  {NOTE_E5, DURATION_346, DURATION_38},
  {NOTE_D5, DURATION_125, DURATION_1113},
  {NOTE_D5, DURATION_92, DURATION_183},
  {NOTE_E5, DURATION_71, DURATION_50},
  {NOTE_D5, DURATION_337, DURATION_21},
  {NOTE_C5, DURATION_183, DURATION_846},
  {NOTE_E5, DURATION_79, DURATION_163},
  {NOTE_E5, DURATION_75, DURATION_175},
  {NOTE_E5, DURATION_67, DURATION_179},
  {NOTE_E5, DURATION_225, DURATION_33},
  {NOTE_F5, DURATION_129, DURATION_1117},
  {NOTE_F5, DURATION_79, DURATION_188},
  {NOTE_F5, DURATION_75, DURATION_150},
  {NOTE_F5, DURATION_250, DURATION_29},
  {NOTE_E5, DURATION_138, DURATION_1079},
  {NOTE_A4, DURATION_217, DURATION_33},
  {NOTE_Cb5, DURATION_175, DURATION_79},
  {NOTE_D5, DURATION_483, DURATION_0},
};

#define MELODY_SIZE sizeof(melody) / sizeof(melody_data)
#define MELODY_TONE(x) melody_tones[melody[x].t]
#define MELODY_NO_TONE(x) melody_durations[melody[x].nd]
#define MELODY_DURATION(x) melody_durations[melody[x].d]

void tone(uint8_t frequency)
{
  if (frequency <= 0) {
    TM2B = 0;
  } else {
    TM2S = 3 << 5 | 2;
    TM2B = frequency;
  }
}

#endif